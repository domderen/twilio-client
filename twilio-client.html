<script src="../twilioclient-fixed/twilio.js"></script>
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../cachable-ajax/cachable-ajax.html">

<script src="../lodash/dist/lodash.min.js"></script>

<!--
Twilio client element, being able to perform outgoing calls, receive incoming calls,
and supports browser-to-browser calls.

##### Example

    <twilio-client
    capailityToken="54h54h7j8k8"
    capailityTokenUrl="<URL-TO-YOUR-TWILIO-APP>"
    number="=48123456789">
    clientName="someName"</twilio-client>

@element twilio-client
@blurb Twilio client element, being able to perform outgoing calls, receive incoming calls,
and supports browser-to-browser calls.
@status alpha
@homepage https://github.com/domderen/twilio-client
-->
<polymer-element name="twilio-client" hidden attributes="capabilityToken capabilityTokenUrl number clientName">
  <script>
    (function () {

      var cachableAjax = document.createElement('cachable-ajax');
      var self;
      var Twilio = utils.TwilioClientFactory();

      Polymer({
        /**
         * Fired when twilio Device has been properly initialized. Contains a single parameter 'device',
         * which holds a reference to the initialized Device.
         *
         * @event device-ready
         */

        /**
         * Fired when twilio Device has stumbled upon an error, either during initialization, or later
         * during regular usage. Contains a single parameter 'error', which contains the details of the error.
         *
         * @event device-error
         */

        /**
         * Fired when twilio Device has established a connection with another client or a number. Contains a single
         * parameter 'connection', which contains the details of the started connection.
         *
         * @event device-connect
         */

        /**
         * Fired when twilio Device has closed a connection with another client or a number. Contains a single
         * parameter 'connection', which contains the details of the ended connection.
         *
         * @event device-disconnect
         */

        /**
         * Fired when twilio Device has detected a presence of another client in the same application. When this event
         * is handled internally it also manages the 'available' array property with the list of clients,
         * so you don't have to do so. It contains a single parameters 'presence', which contains the details of
         * the presence that has just appeared or disappeared in the application.
         *
         * @event device-presence
         */

        /**
         * `capabilityToken` is a token generated by your server with proper capabilities.
         * This parameter can also accept a Promise which will return the capabilityToken, once resolved.
         *
         * @property capabilityToken
         * @type string
         * @default ''
         */
        capabilityToken: '',

        /**
         * `capabilityTokenUrl` is an address from where the token can be obtained. If provided, component will
         * send a GET request to a given Url, and expecting a HTTP response:
         * - With Content-Type: text/html,
         * - With http status code: 200,
         * - With capabilityToken written in response body, as a plain text.
         *
         * @property capabilityTokenUrl
         * @type string
         * @default ''
         */
        capabilityTokenUrl: '',

        /**
         * 'clientName' is a name that will identify this browser with your server side application.
         * If this value is provided, it will be used together with capabliltyTokenUrl as a parameter to the request,
         * defining for your server application, what name does this browser has, before generating a token.
         *
         * @attribute clientName
         * @type string
         * @default ''
         */
        clientName: '',

        /**
         * 'number' is the number to call for outgoing calls.
         *
         * @attribute number
         * @type string
         * @default ''
         */
        number: '',

        /**
         * 'available' is the array of clients being currently available in the application.
         *
         * @attribute available
         * @type array
         * @default '[]'
         */
        available: [],

        /**
         * 'auto' If true, automatically performs component startup.
         *
         * @attribute auto
         * @type boolean
         * @default false
         */
        auto: false,

        /**
         * 'activeConnection' Returns an active connection with the Twilio Device, if one exisits.
         *
         * @attribute activeConnection
         * @type object
         * @default undefined
         */
        get activeConnection() {
          return Twilio.Device.activeConnection();
        },

        /**
         * 'device' Returns a Device singleton from the Twilio Client.
         *
         * @attribute device
         * @type object
         * @default undefined
         */
        get device() {
          return Twilio.Device;
        },

        ready: function () {
          cachableAjax.auto = false;
          self = this;
        },

        capabilityTokenChanged: function () {
          self.autoInit();
        },

        capabilityTokenUrlChanged: function () {
          self.autoInit();
        },

        autoChanged: function () {
          self.autoInit();
        },

        autoInit: function () {
          if(self.auto && !self.initialized) {
            self.initJob = self.job(self.initJob, self.init, 0);
          }
        },

        /**
         * The `init` initializes the component, by setting up the Twilio Device.
         * This method has to be called manually, if 'auto' is set to false, or previous initialization
         * has failed.
         *
         * @method init
         */
        init: function () {
          if (self.capabilityToken) {
            Promise.resolve().then(function () { return self.capabilityToken; }).then(self.setupClient);
          } else if (self.capabilityTokenUrl) {
            self.getToken().then(self.setupClient);
          } else {
            throw new Error('No configuration parameters provided. Please provide either "capabilityToken" or ' +
            'the "capabilityTokenUrl". For further details, please consult the documentation.');
          }

          self.initialized = true;
        },

        setupClient: function (capabilityToken) {
          Twilio.Device.setup(capabilityToken || self.capabilityToken);

          Twilio.Device.ready(function (device) {
            self.fire('device-ready', {device: device});
          });

          Twilio.Device.error(function (error) {
            self.fire('device-error', {error: error});
            self.initialized = false;
          });

          Twilio.Device.connect(function (connection) {
            self.fire('device-connect', {connection: connection});
          });

          Twilio.Device.disconnect(function (connection) {
            self.fire('device-disconnect', {connection: connection});
          });

          Twilio.Device.incoming(function (connection) {
            self.fire('device-incoming', {connection: connection});
          });

          Twilio.Device.presence(function (presence) {
            self.fire('device-presence', {presence: presence});

            var alreadyExists = _.find(self.available, function (av) {
              return av.from === presence.from;
            });

            if (alreadyExists) {
              alreadyExists.available = presence.available;
            }
            else {
              self.available.push(presence);
            }
          });
        },

        getToken: function () {
          cachableAjax.url = self.capabilityTokenUrl;

          if (self.clientName) {
            cachableAjax.params = {clientName: self.clientName};
          }

          return cachableAjax.go().then(function (token) {
            self.capabilityToken = token;
          }, function (err) {
            throw new Error('The request for capabilityTokenUrl has failed. Please confirm the correctness of the' +
            'url, and try again. If it still does not work, please check your server setup.\n' + err);
          });
        },

        isValidPhoneNumber: function (phone) {
          var regex = /^\+(?:[0-9] ?){6,14}[0-9]$/;

          return !!regex.test(phone);
        },

        /**
         * The `call` method performs the connection to the twilio device.
         *
         * @param callParam can be either an object, in which case, it is passed as an argument to the connection,
         * or it can be a string containing the number or client name. In case of the number, Twilio Device will
         * twy to connect to a given number sending a request parameter {PhoneNumber: callParam}. In case of the
         * client name, the sent param will have a form {ClientName: callParam}. This parameter is used to
         * communicate with your server application, and will be delivered to your Voice URL, as a parameter to
         * the request sent by Twilio Application. For details of usage, have a look at the demo-server index.js file,
         * and especially the handler for the "/" path.
         * @method call
         */
        call: function (callParam) {
          if(callParam !== null && typeof callParam === 'object') {
            Twilio.Device.connect(callParam);
          } else {
            var params;

            if (self.isValidPhoneNumber(callParam || self.number)) {
              params = {"PhoneNumber": callParam || self.number};
            } else if (callParam || self.number) {
              params = {"ClientName": callParam || self.number};
            }

            Twilio.Device.connect(params);
          }
        },

        /**
         * The `hangUp` method disconnects all connections to the twilio device.
         *
         * @method hangUp
         */
        hangUp: function () {
          Twilio.Device.disconnectAll();
        },

        /**
         * The `anyKey` method simulates pressing '1' on the keypad, to move forward with the messages.
         *
         * @method anyKey
         */
        anyKey: function () {
          var conn = Twilio.Device.activeConnection();
          if (conn) {
            conn.sendDigits('1');
          }
        },

        /**
         * The `acceptConnection` starts a connections, if one is pending.
         *
         * @method acceptConnection
         */
        acceptConnection: function () {
          var connection = Twilio.Device.activeConnection();
          if (connection) {
            connection.accept();
          }
        }
      });
    })();
  </script>
</polymer-element>
